<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ذكية - المساعدة الصوتية لعلم النفس التربوي</title>
    <style>
        :root {
            --primary-color: #6c63ff;
            --error-color: #ff4757;
            --background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Tajawal', Arial, sans-serif;
            background: var(--background);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px 0;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .voice-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .voice-btn {
            background: var(--primary-color);
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(108, 99, 255, 0.3);
        }
        
        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(108, 99, 255, 0.4);
        }
        
        .voice-btn.active {
            background: var(--error-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #voiceIcon {
            width: 40px;
            height: 40px;
            pointer-events: none;
        }
        
        #status {
            color: #666;
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
        }
        
        .conversation {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .message.user {
            justify-content: flex-start;
        }
        
        .message.assistant {
            justify-content: flex-end;
        }
        
        .bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            word-break: break-word;
        }
        
        .user .bubble {
            background: #e3f2fd;
            border-bottom-left-radius: 5px;
        }
        
        .assistant .bubble {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .error {
            color: var(--error-color);
            font-weight: bold;
        }
        
        .typing-indicator {
            display: inline-block;
            margin-left: 5px;
        }
        
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            margin-right: 3px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        /* تحسينات للهواتف */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                border-radius: 15px;
            }
            
            .voice-btn {
                width: 70px;
                height: 70px;
            }
            
            #voiceIcon {
                width: 35px;
                height: 35px;
            }
            
            .conversation {
                min-height: 150px;
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://i.imgur.com/7QZ4m9J.png" alt="شعار ذكية" class="logo">
            <h1>ذكية</h1>
            <p class="subtitle">المساعدة الصوتية لعلم النفس التربوي</p>
        </header>

        <div class="voice-container">
            <button id="voiceBtn" class="voice-btn" aria-label="زر التحدث">
                <img src="https://i.imgur.com/3JxV7QO.png" alt="زر التحدث" id="voiceIcon">
            </button>
            <p id="status">اضغط على الزر للتحدث</p>
        </div>

        <div class="conversation" id="conversation">
            <div class="message assistant">
                <div class="bubble">مرحباً! أنا ذكية، مساعدتك في علم النفس التربوي. اسألني عن نظريات الذكاء أو أساليب التعلم.</div>
            </div>
        </div>
    </div>

    <script>
        // ========== العناصر الرئيسية ==========
        const voiceBtn = document.getElementById('voiceBtn');
        const statusEl = document.getElementById('status');
        const conversationEl = document.getElementById('conversation');
        const voiceIcon = document.getElementById('voiceIcon');

        // ========== حالة التطبيق ==========
        let isListening = false;
        let recognition;
        const synth = window.speechSynthesis;
        let voices = [];
        let isSpeaking = false;

        // ========== قاعدة المعرفة ==========
        const knowledgeBase = {
            "الذكاء": "الذكاء مفهوم متعدد الأبعاد يشمل القدرات المعرفية والعاطفية والاجتماعية. حسب نظرية جاردنر للذكاءات المتعددة يوجد 8 أنواع من الذكاء: لغوي، منطقي-رياضي، مكاني، جسدي-حركي، موسيقي، بين شخصي، داخل شخصي، وطبيعي.",
            "نظرية جاردنر": "نظرية الذكاءات المتعددة التي طورها هوارد جاردنر تقترح أن الذكاء ليس قدرة واحدة عامة، بل مجموعة من القدرات المستقلة. هذه النظرية غيرت طرق التدريس لتلائم أنواع الذكاء المختلفة.",
            "الذكاء العاطفي": "هو القدرة على فهم وإدارة العواطف الشخصية وعواطف الآخرين. حسب دانيال جولمان، الذكاء العاطفي يتكون من خمسة مكونات: الوعي الذاتي، التنظيم الذاتي، التحفيز، التعاطف، والمهارات الاجتماعية.",
            "التعلم": "أفضل طرق التعلم تشمل: 1) الممارسة الموزعة (توزيع وقت التعلم) 2) الاختبار الذاتي 3) التكامل بين المفاهيم الجديدة والمعرفة السابقة 4) التعليم المتمايز حسب أنماط التعلم.",
            "التربية": "التربية الفعالة تعتمد على فهم الفروق الفردية في الذكاء وتوفير بيئة تعلم غنية تحفز مختلف أنواع الذكاء. أهم مبادئها: التشجيع الإيجابي، التعلم باللعب، والتقييم التكويني."
        };

        // ========== تهيئة التعرف الصوتي ==========
        function initSpeechRecognition() {
            // التحقق من دعم المتصفح
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                throw new Error('المتصفح لا يدعم التعرف على الصوت');
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // إعدادات التعرف الصوتي
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ar-SA';
            recognition.maxAlternatives = 1;

            // معالجة الأحداث
            recognition.onstart = () => {
                console.log('بدء الاستماع...');
                isListening = true;
                updateUI();
                showStatus("جاري الاستماع...");
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript.trim();
                console.log('تم التعرف على:', transcript);
                await handleUserInput(transcript);
            };

            recognition.onerror = (event) => {
                console.error('حدث خطأ:', event.error);
                showError(getErrorMessage(event.error));
                resetState();
            };

            recognition.onend = () => {
                console.log('انتهى الاستماع');
                if (isListening) {
                    recognition.start();
                }
            };

            return recognition;
        }

        // ========== معالجة الأخطاء ==========
        function getErrorMessage(error) {
            const errors = {
                'no-speech': 'لم يتم اكتشاف أي كلام',
                'audio-capture': 'لا يمكن الوصول إلى الميكروفون',
                'not-allowed': 'تم رفض إذن استخدام الميكروفون',
                'aborted': 'تم إيقاف التعرف على الصوت',
                'network': 'مشكلة في الشبكة',
                'language-not-supported': 'اللغة غير مدعومة'
            };
            return errors[error] || 'حدث خطأ غير متوقع في التعرف على الصوت';
        }

        // ========== التعامل مع مدخلات المستخدم ==========
        async function handleUserInput(input) {
            try {
                // إظهار رسالة المستخدم
                addMessage(input, 'user');
                
                // إظهار مؤشر الكتابة
                showTypingIndicator();
                
                // محاكاة وقت المعالجة
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // إخفاء مؤشر الكتابة
                hideTypingIndicator();
                
                // توليد الرد
                const response = generateResponse(input);
                
                // إظهار الرد
                addMessage(response, 'assistant');
                
                // التحدث بالرد
                await speak(response);
            } catch (error) {
                console.error('Error handling input:', error);
                showError('حدث خطأ أثناء معالجة طلبك');
            } finally {
                if (isListening) {
                    recognition.start();
                }
            }
        }

        // ========== توليد الرد ==========
        function generateResponse(input) {
            input = input.toLowerCase();
            
            // البحث عن تطابق في قاعدة المعرفة
            for (const [keyword, response] of Object.entries(knowledgeBase)) {
                if (input.includes(keyword.toLowerCase())) {
                    return response;
                }
            }
            
            // الردود الافتراضية
            const defaultResponses = [
                "يمكنك سؤالي عن نظريات الذكاء أو أساليب التعلم الفعالة",
                "أنا متخصصة في علم النفس التربوي. هل لديك استفسار عن الذكاء العاطفي؟",
                "أسعد بالإجابة عن أسئلتك في مجال علم النفس التربوي وتنمية الذكاء",
                "للحصول على أفضل إجابة، ركز سؤالك على مواضيع علم النفس التربوي والذكاء"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        // ========== وظيفة التحدث ==========
        function speak(text) {
            return new Promise((resolve, reject) => {
                if (isSpeaking) {
                    synth.cancel();
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.85;
                utterance.pitch = 1.1;
                
                // اختيار أفضل صوت عربي
                const arabicVoices = voices.filter(v => v.lang.includes('ar'));
                if (arabicVoices.length > 0) {
                    utterance.voice = arabicVoices.find(v => v.name.includes('Female')) || arabicVoices[0];
                }
                
                utterance.onstart = () => {
                    isSpeaking = true;
                    voiceIcon.src = 'https://i.imgur.com/5X0wR2T.png';
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                    voiceIcon.src = 'https://i.imgur.com/3JxV7QO.png';
                    resolve();
                };
                
                utterance.onerror = (event) => {
                    isSpeaking = false;
                    console.error('حدث خطأ في الكلام:', event.error);
                    reject(event.error);
                };
                
                synth.speak(utterance);
            });
        }

        // ========== وظائف مساعدة للواجهة ==========
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<div class="bubble">${text}</div>`;
            conversationEl.appendChild(messageDiv);
            scrollToBottom();
        }

        function showStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.className = isError ? 'error' : '';
        }

        function showError(text) {
            showStatus(text, true);
            setTimeout(() => showStatus("اضغط على الزر للتحدث"), 3000);
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="bubble">
                    ذكية تكتب
                    <span class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </span>
                </div>
            `;
            conversationEl.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            conversationEl.scrollTop = conversationEl.scrollHeight;
        }

        function updateUI() {
            voiceBtn.classList.toggle('active', isListening);
            voiceIcon.src = isListening ? 
                'https://i.imgur.com/5X0wR2T.png' : 
                'https://i.imgur.com/3JxV7QO.png';
        }

        function resetState() {
            isListening = false;
            updateUI();
            showStatus("اضغط على الزر للتحدث");
        }

        // ========== تحميل الأصوات ==========
        function loadVoices() {
            return new Promise((resolve) => {
                voices = synth.getVoices();
                if (voices.length > 0) {
                    console.log('الأصوات المتاحة:', voices);
                    resolve(voices);
                } else {
                    synth.onvoiceschanged = () => {
                        voices = synth.getVoices();
                        console.log('الأصوات المحملة:', voices);
                        resolve(voices);
                    };
                }
            });
        }

        // ========== حدث الضغط على الزر ==========
        voiceBtn.addEventListener('click', async () => {
            try {
                if (!isListening) {
                    // بدء الاستماع
                    if (!recognition) {
                        recognition = initSpeechRecognition();
                    }
                    
                    // طلب إذن الميكروفون
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    await loadVoices();
                    recognition.start();
                } else {
                    // إيقاف الاستماع
                    recognition.stop();
                    resetState();
                }
            } catch (error) {
                console.error('حدث خطأ:', error);
                showError(error.message);
                resetState();
            }
        });

        // ========== التهيئة الأولية ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // تحميل الأصوات
                await loadVoices();
                
                // التحقق من دعم المتصفح
                if (!('webkitSpeechRecognition' in window) {
                    throw new Error('المتصفح غير مدعوم. يرجى استخدام Chrome أو Edge');
                }
                
                // التحقق من وجود أصوات عربية
                const arabicVoices = voices.filter(v => v.lang.includes('ar'));
                if (arabicVoices.length === 0) {
                    console.warn('لا توجد أصوات عربية متاحة. قد لا يعمل الصوت بشكل صحيح');
                }
                
                // إظهار رسالة ترحيبية
                setTimeout(() => {
                    speak("مرحباً! أنا ذكية، مساعدتك في علم النفس التربوي. اضغط على الزر الأحمر للتحدث معي");
                }, 1000);
                
            } catch (error) {
                console.error('خطأ في التهيئة:', error);
                showError(error.message);
                voiceBtn.disabled = true;
            }
        });
    </script>
</body>
</html>
